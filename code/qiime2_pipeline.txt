#Resolución Actividad 3 secuenciación y ómicas de próxima generación

# PASO 1: PREPARACIÓN DEL ENTORNO Y CARPETA DE TRABAJO
#Primero, se crea un entorno conda con la versión qiime2 2023.9
#según indica la página web https://docs.qiime2.org/2023.9/install/native/#

wget https://data.qiime2.org/distro/amplicon/qiime2-amplicon-2023.9-py38-linux-conda.yml
#este archivo contiene instrucciones sobre como crear el entorno (qué versión de python, paquetes necesarios, etc)

conda env create -n qiime2-2023.9 --file qiime2-amplicon-2023.9-py38-linux-conda.yml

#Una vez creado el entorno conda, creamos una carpeta para almacenar todos los archivos de la actividad

mkdir qiime2-atacama

# PASO 2. CARGA DE DATOS Y GENERACIÓN DEL ARTEFACTO QIIME2
#se van a descargar los archivos de:
# -Metadatos: contiene información sobre cada muestra tomada (barcode, sitio donde fue tomada, a qué amplitud, concentración del amplicón 16s, etc)
# -Lecturas forward (multiplexadas)
# -Lecturas reverse (multiplexadas)
# -Secuencias de los barcodes

#Una vez descargados los datos, para poder analizarlos, necesitan ser importados en un artefacto .qza de tipo secuencias paired-end. Se usa el comando EMPPairedEndSequences:

qiime tools import \
   --type EMPPairedEndSequences \
   --input-path emp-paired-end-sequences \
   --output-path emp-paired-end-sequences.qza
 
#Se genera un archivo .qza llamado emp-paired-end-sequences
#De esta forma, ya tenemos la secuencia listas para continuar con el demultiplexing:

#PASO 3. DEMULTIPLEXING

qiime demux emp-paired \
  --m-barcodes-file sample-metadata.tsv \ #archivo con los barcodes
  --m-barcodes-column barcode-sequence \ #columna
  --p-rev-comp-mapping-barcodes \ #indicar que las sec de los barcodes son el reverso complementario 
  --i-seqs emp-paired-end-sequences.qza \ #carpeta con las secuencias y barcodes
  --o-per-sample-sequences demux-full.qza \ #ruta donde guardar los artefactos de salida, que contendrá las sec demultiplexadas
  --o-error-correction-details demux-details.qza 
  
# PASO 4. SUBMUESTREO
#Una vez hecho esto se va a hacer una submuestra del 30% para reducir el coste computacional 
  qiime demux subsample-paired \ #función para hacer el submuestreo
  --i-sequences demux-full.qza \
  --p-fraction 0.3 \
  --o-subsampled-sequences demux-subsample.qza

#El siguiente paso es generar un archivo que nos permita generar gráficos para visualizar el conjunto de datos y explorarlos:

qiime demux summarize \
  --i-data demux-subsample.qza \
  --o-visualization demux-subsample.qzv
  
#Este archivo muestra un resumen de las secuencias demultiplexadas del submuestreo, si lo cargamos en qiime 2, https://view.qiime2.org/visualization/?src=3256d1af-5f40-44cf-85ff-afe0c8ca97ee, se observan histogramas y tablas del numero de lecturas por muestra para el forward y reverse

#En la pestaña interactive quality podemos ver gráficos de calidad según la posición en la lectura tanto para forward como reverse. Se puede observar de manera general que la calidad para las reverse es menor desde el comienzo de la lectura. 
#En la tabla que le sigue se observa la longitud de las lecturas (nt) obtenidos por cada 10000 secuencias

#PASO 5. FILTRADO
#El siguiente paso es filtrar las muestras con menos de 100 lecturas, puesto que no aportan información y pueden introducir falsos resultados. 

#Primero, exportamos las visualizaciones de la submuestra: 
qiime tools export \
  --input-path demux-subsample.qzv \
  --output-path ./demux-subsample/

#En la nueva carpeta creada demux-subsample se encuentran los ficheros con las gráficas y los html 

#Y filtramos:

qiime demux filter-samples \ #función para hacer el filtrado 
  --i-demux demux-subsample.qza \ #input: artefacto del demultiplexado
  --m-metadata-file ./demux-subsample/per-sample-fastq-counts.tsv \ #archivo de metadatos que contiene el número de sec por muestra (necesario para hacer el filtrado), que se ha generado en el paso anterior
  --p-where 'CAST([forward sequence count] AS INT) > 100' \ #condicion de filtrado. Se especifica la columna del archivo como numero entero y que retenga los mayores a 100. 
  --o-filtered-demux demux.qza #archivo de salida 

# PASO 6. ELIMINACIÓN DE RUIDO (DENOISING)
#El siguiente paso es eliminación de ruido. Para ello habría que revisar los plots de calidad. En este caso, se van a eliminar sólo las 13 primeras bases de las lecturas forward y reverse (normalmente se hace para eliminar primers). Al ser la longitud de ~150 pb, no se va a eliminar del final de la secuencia por no quedarnos con lecturas cortas. A  su vez, se van a truncar las secuencias en la posición 150. En teoría, el truncado se hace según las gráficas de calidad, en la posición donde la calidad decaiga considerablemente. 

qiime dada2 denoise-paired \
  --i-demultiplexed-seqs demux.qza \ #input. Nuestras lecturas demultiplexadas y filtradas 
  --p-trim-left-f 13 \ #corte por la izquierda en el nt 13 de las lec forward
  --p-trim-left-r 13 \ #corte reverse
  --p-trunc-len-f 150 \ #filtrado de longitud
  --p-trunc-len-r 150 \
  --o-table table.qza \ #tabla output de la frecuencia de OTUs
  --o-representative-sequences rep-seqs.qza \ #secuencias de los OTUs
  --o-denoising-stats denoising-stats.qza #estadísticas de la remoción de ruido
  
#Una vez generados los archivos hay que obtener los archivos de visualización en formato .qzv:

qiime feature-table summarize \ #tabla de frecuencias
  --i-table table.qza \
  --o-visualization table.qzv \
  --m-sample-metadata-file sample-metadata.tsv #archivo de metadatos

#Abriendo el archivo se observa al principio una tabla resumen donde, del total de 54 muestras, se obtuvieron 1118 features (OTUs) con frecuencia total 63826. A continuación se observan histogramas con las frecuencias de los OTUs. 
#En la siguiente pestaña hay gráficos interactivos con las características del archivo de metadatos. Se puede mover la profundidad de muestreo a un número específico de observaciones, observando las muestras que se eliminarían si retuviésemos aquellas con un número específico de lecturas.
#En la última pestaña vemos las características de cada OTU.

qiime feature-table tabulate-seqs \ #secuencias representativas
  --i-data rep-seqs.qza \
  --o-visualization rep-seqs.qzv
  
#Este archivo contiene una tabla con el número de OTUs diferentes, que son 1118 en este caso con una longitud promedio de 227 nt. Mas abajo se especifica la secuencia de cada uno.

qiime metadata tabulate \ #resumen de los estadisticos generados por DADA2
  --m-input-file denoising-stats.qza \
  --o-visualization denoising-stats.qzv

# PASO 7: GENERAR ÁRBOL PARA DIVERSIDAD FILOGENÉTICA
#El siguiente paso consiste en generar un árbol para el análisis de diversidad filogenética: 

qiime phylogeny align-to-tree-mafft-fasttree \
--i-sequences rep-seqs.qza \
--o-alignment aligned-rep-seqs.qza \
--o-masked-alignment masked-aligned-rep-seqs.qza \
--o-tree unrooted-tree.qza --o-rooted-tree rooted-tree.qza

#Para poder visualizar el árbol en plataformas como microreact, lo exportamos: 

qiime tools export \
--input-path rooted-tree.qza \
--output-path visualizacion_arbol/ #ruta de destino del archivo de salida, he creado una carpeta llama visualizacion_arbol

#Se obtiene un archivo con extensión .nwk (neewick)

# PASO 8. CÁLCULO DE DIVERSIDAD ALFA Y BETA

#A continuación, se van a calcular diferentes métricas de diversidad alfa (dentro de la muestra) y beta (entre muestras). Para ello, ha de realizarse la rarefacción, que es un método de normalización para corregir las diferencias de profundidad de lectura entre muestras. Por ejemplo, un muestra con una secuenciación más profunda tiene mayor probabilidad de presentar mayor diversidad que una muestra con profundidad baja. 

#La rarefacción consiste en submuestrar las lecturas hasta una profundidad de secuenciación definida, creando así un tamaño de lecturas estandarizado para todas las muestras. 
#Para seleccionar una profundidad de muestreo adecuada, podemos fijarnos en la gráfica de frecuencias por muestra y observar el valor máximo, mínimo, la mediana... Además, en la pestaña de gráficos interactivos, se puede probar diferentes valores de profundidad para observar cuantas muestras se retendrían. 
#Existen también los gráficos de rarefacción alfa, donde se representa el número de OTUs respecto a la profundidad de secuenciación para cada muestra. Con estos gráficos se puede elegir la profundidad a la que el número de OTUs observados se estabiliza. Se crean con:

qiime diversity alpha-rarefaction \
--i-table table.qza \ #input. Tabla de frecuencias
--i-phylogeny rooted-tree.qza \ #Árbol filogenético generado (opcional)
--m-metadata-file sample-metadata.tsv \ #Archivo de metadatos
--p-max-depth 1100 \ #nº máximo de profundidad para generar las curvas. Se ha elegido el valor de la mediana aprox pero también puede elegirse según las gráficas interactivas.
--o-visualization alpha-rarefaction-plot.qzv 

#En la gráfica se puede observar que entre 300 y 400 lecturas el número de features (OTUs) se estabiliza, por lo que por mucho que se aumente en profundidad no se ganará significativamente en diversidad. También se puede representar el índice de Shannon y Faith en el eje de las abcisas para ver el aumento de riqueza y distribución. En la pestaña interactiva de la visualización table.qzv, se observa que si establecemos la profundidad en 350 lecturas se pierden 4 muestras, mientras que para 300 se pierden 2. Por lo tanto, la profundidad de secuenciación escogida para la rarefacción será de 300, puesto que tampoco hay mucha ganancia de diversidad a costa de perder 2 muestras más. 

qiime diversity core-metrics-phylogenetic \
--i-phylogeny rooted-tree.qza \
--i-table table.qza \
--p-sampling-depth 300 \
--m-metadata-file sample-metadata.tsv \
--output-dir core-metrics-results


# 8.1. Análisis por grupo de metadatos
#En este paso, se pueden agrupar los resultados de acuerdo con las diferentes variables de los metadatos (zona, ph, humedad, etc), y evaluar las diferencias en su diversidad según cada categoría.

#Para conocer la variable categórica asociada con más fuerza a las diferencias en la riqueza de la comunidad, habría que emplear el parámetro observed_features o faith-pd (que tiene en cuenta la filogenia).

qiime diversity alpha-group-significance \
--i-alpha-diversity core-metrics-results/observed_features_vector.qza \
--m-metadata-file sample-metadata.tsv \
--o-visualization core-metrics-results/observed-features-group-significante.qzv

#En el archivo generado puede observarse un boxplot interactivo del número de OTUs observados (observed_features) frente a la variable categórica de los metadatos, que puede escogerse a través del desplegable. En este caso, se observa gran variabilidad según site_name (nombre del sitio donde se tomo la muestra) y vegetation (ausencia o presencia de vegetación) ambos con p values inferiores a 0,05 según el test de Kruskal-Wallis. Esto quiere decir que donde hay más vegetación hay mas riqueza de especies (valores de OTUS observados más altos).

#Para conocer la variable categórica asociada con más fuerza a las diferencias en abudancia entre especies (igualdad), habría que emplear el parámetro de diversidad de shannon o la igualdad de eveness:

qiime diversity alpha-group-significance \
--i-alpha-diversity core-metrics-results/evenness_vector.qza \
--m-metadata-file sample-metadata.tsv \
--o-visualization core-metrics-results/evenness-group-significance.qzv

#En este caso, se observan diferencias significativas en abundancia entre especies según el transecto (Baquedano o Yungay).

#En resumen, la riqueza de especies se asocia más fuertemente con el sitio específico de muestreo y la presencia o ausencia de vegetación, mientras que la igualdad está más asociada con el transecto. 

# 8.2 Análisis PERMANOVA
#Este análisis se realiza para evaluar la significancia estadística de las diferencias en la composición de especies entre comunidades. 
#Se ha selecionado la métrica de la distancia bray curtis según el transecto.
qiime diversity beta-group-significance \
--i-distance-matrix core-metrics-results/bray_curtis_distance_matrix.qza \
--m-metadata-file sample-metadata.tsv \
--m-metadata-column transect-name \
--o-visualization core-metrics-results/bray-curtis-transect-name-significance.qzv

# 8.3. PCoA
qiime emperor plot \
--i-pcoa core-metrics-results/bray_curtis_pcoa_results.qza \
--m-metadata-file sample-metadata.tsv \
--o-visualization  core-metrics-results/bray_curtis_emperor.qzv

# PASO 9. ANÁLISIS TAXONÓMICO 
#Vamos a utilizar un clasificador entrenado para asignar identidades taxonómicas a las secuencias representativas de los OTU (fichero rep-seqs.qzv), basado en la base de datos Greengenes. 

#Descarga del clasificador: 
wget -O "gg-13-8-99-515-806-nb-classifier.qza" "https://data.qiime2.org/2023.9/common/gg-13-8-99-515-806-nb-classifier.qza"

#Clasificación taxonómica:
qiime feature-classifier classify-sklearn \
--i-classifier gg-13-8-99-515-806-nb-classifier.qza \
--i-reads rep-seqs.qza \
--o-classification taxonomy.qza

#A continuación, creamos una tabla que resume la información taxonómica contenida en el archivo de clasificación, que corresponde al archivo de salida del comando anterior
qiime metadata tabulate \
--m-input-file taxonomy.qza \
--o-visualization taxonomy.qzv

#Dicha tabla contiene las identidades taxonómicas asignadas a cada OTU.

#Vamos a crear un gráfico de abundancia taxonómica:
qiime taxa barplot \
--i-table table.qza \ #archivo con las frecuencias de OTUs
--i-taxonomy taxonomy.qza \ #asignación taxonómica
--m-metadata-file sample-metadata.tsv \
--o-visualization taxa-bar-plots.qzv

#El gráfico creado (taxa-bar-plots.qzv) representa la frecuencia relativa de identidades taxonómicas para cada especie. Se puede elegir el nivel taxonómico a representar (Siendo el 1 el menos detallado, correspondiente al Reino, y el 7 el más específico, correspondiente a la especie).

# PASO 10. ANÁLISIS DIFERENCIAL DE ABUNDANCIA MICROBIANA (ANCOM)

#Este análisis tiene como objetivo encontrar taxones con una abundancia diferencial entre grupos de muestras. 

#Primero, se debe añadir una suma de un número pequeño a todas las celdas de la tabla de frecuencias para que no haya 0, puesto que ANCOM calcula relaciones logarítmicas. 

qiime composition add-pseudocount \
--i-table table.qza \
--o-composition-table ANCOM/comp-table.qza #directorio nuevo 

#Ahora se puede ejecutar el análisis ANCOM:
qiime composition ancom \
--i-table ANCOM/comp-table.qza \
--m-metadata-file sample-metadata.tsv \
--m-metadata-column transect-name \
--o-visualization ANCOM/ancom-transect-name.qzv

#ANCOM no elige ningún nivel de taxonomía automáticamente, usa la tabla que le damos como entrada, que simplemente es la frecuencia de cada OTU, por tanto, si queremos trabajar a algún nivel taxonómico, primero hay que usar el comando qiime taxa collapse:

qiime taxa collapse --i-table table.qza --i-taxonomy taxonomy.qza --p-level 5 --o-collapsed-table table-l5.qza

#En este caso, empleamos el nivel 5 (familia) para no ser ni muy específico ni muy amplio. 

#Una vez hecho esto, repetimos los dos pasos anteriores, empleando en este caso la tabla recién creada:

qiime composition add-pseudocount --i-table table-l5.qza --o-composition-table ANCOM/comp-table-l5.qza

qiime composition ancom --i-table ANCOM/comp-table-l5.qza --m-metadata-file sample-metadata.tsv --m-metadata-column transect-name --o-visualization ANCOM/l5-ancom-transect-name.qzv

#Se puede ir porbando con diferentes columnas categóricas de los metadatos o niveles taxonomicos 







